<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æš—è‰²ç®€çº¦èŠå¤©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root {
        --bg: #1a1a1a;
        --card: #252525;
        --text: #e0e0e0;
        --primary: #00bfff;
        --danger: #ff4444;
        --success: #44cc44;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
        background:var(--bg); color:var(--text); font-family:Arial,Helvetica,sans-serif;
        height:100vh; overflow:hidden; position:relative;
    }
    .modal {
        position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:100;
    }
    .modal-content {
        background:var(--card); padding:2rem; border-radius:12px; width:90%; max-width:360px; text-align:center;
    }
    input, button {
        width:100%; padding:0.8rem; margin:0.5rem 0; border:none; border-radius:8px; font-size:1rem;
    }
    input { background:#333; color:var(--text); }
    button { background:var(--primary); color:#fff; cursor:pointer; }
    button:hover { opacity:0.9; }
    button.danger { background:var(--danger); }
    button.success { background:var(--success); }
    .avatar {
        width:48px; height:48px; border-radius:50%; object-fit:cover; cursor:pointer;
    }
    #main {
        display:grid; grid-template-columns:260px 1fr; height:100vh;
    }
    #sidebar {
        background:#222; padding:1rem; overflow-y:auto;
    }
    #user-info { display:flex; align-items:center; gap:12px; margin-bottom:1rem; }
    #search-btn { position:absolute; top:1rem; right:1rem; padding:0.5rem 1rem; }
    #chat-area { background:#1e1e1e; display:flex; flex-direction:column; }
    #chat-list { flex:1; overflow-y:auto; padding:1rem; }
    .msg { max-width:70%; margin:0.5rem 0; padding:0.8rem; border-radius:12px; }
    .msg.me { background:var(--primary); align-self:flex-end; }
    .msg.other { background:#333; align-self:flex-start; }
    #input-area { display:flex; padding:0.5rem; gap:0.5rem; background:#222; }
    #input-area input { flex:1; }
    #input-area button { width:auto; padding:0 1rem; }
    .request-notif {
        position:fixed; bottom:1rem; right:1rem; background:var(--primary); color:#fff;
        padding:0.8rem 1.2rem; border-radius:50px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.5);
    }
    .hidden { display:none !important; }
    .friend-item { display:flex; align-items:center; gap:12px; padding:0.75rem; cursor:pointer; border-bottom:1px solid #333; }
    .friend-item:hover { background:#2a2a2a; }
</style>
</head>
<body>

<!-- ç™»å½•å¼¹çª— -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <h2>ç™»å½•</h2>
        <input id="login-user" placeholder="è¾“å…¥ç”¨æˆ·å" maxlength="12">
        <input id="login-pass" type="password" placeholder="è¾“å…¥å¯†ç " maxlength="16">
        <button onclick="login()">ç™»å½•</button>
        <button class="danger" onclick="showRegister()">æ³¨å†Œ</button>
    </div>
</div>

<!-- æ³¨å†Œå¼¹çª— -->
<div id="register-modal" class="modal hidden">
    <div class="modal-content">
        <h2>æ³¨å†Œ</h2>
        <input id="reg-user" placeholder="ç”¨æˆ·å (6-12ä½å­—æ¯æ•°å­—)" maxlength="12">
        <input id="reg-pass" type="password" placeholder="å¯†ç  (8-16ä½å­—æ¯æ•°å­—)" maxlength="16">
        <input id="reg-pass2" type="password" placeholder="ç¡®è®¤å¯†ç " maxlength="16">
        <div style="margin:1rem 0;">
            <label style="display:block; margin-bottom:0.5rem;">ä¸Šä¼ å¤´åƒ</label>
            <input type="file" id="reg-avatar" accept="image/*">
            <img id="avatar-preview" class="avatar hidden" style="margin-top:0.5rem;">
        </div>
        <button onclick="register()">æ³¨å†Œ</button>
        <button class="danger" onclick="showLogin()">è¿”å›ç™»å½•</button>
    </div>
</div>

<!-- æ˜µç§°å¼¹çª— -->
<div id="name-modal" class="modal hidden">
    <div class="modal-content">
        <h2>å–ä¸ªæ˜µç§° (1-6ä½)</h2>
        <input id="nickname" placeholder="æ˜µç§°" maxlength="6">
        <button onclick="saveNickname()">ç¡®å®š</button>
    </div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div id="main" class="hidden">
    <div id="sidebar">
        <div id="user-info">
            <img id="my-avatar" class="avatar" onclick="copyMyId()">
            <div>
                <div id="my-name"></div>
                <small style="color:#888;" id="my-id"></small>
            </div>
        </div>
        <div id="friend-list"></div>
    </div>
    <div id="chat-area">
        <button id="search-btn" onclick="showSearch()">æœç´¢</button>
        <div id="chat-list"></div>
        <div id="input-area" class="hidden">
            <input id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
            <input type="file" id="img-input" accept="image/*" style="display:none;">
            <button onclick="document.getElementById('img-input').click()">ğŸ“·</button>
            <button onclick="sendMessage()">å‘é€</button>
            <button onclick="startVoice()">ğŸ¤</button>
        </div>
    </div>
</div>

<!-- æœç´¢å¼¹çª— -->
<div id="search-modal" class="modal hidden">
    <div class="modal-content">
        <h2>æœç´¢ç”¨æˆ·</h2>
        <input id="search-id" placeholder="è¾“å…¥å¯¹æ–¹ç¼–å· (6-12ä½æ•°å­—)" maxlength="12">
        <button onclick="searchUser()">æœç´¢</button>
        <button class="danger" onclick="hideSearch()">å–æ¶ˆ</button>
        <div id="search-result" style="margin-top:1rem;"></div>
    </div>
</div>

<!-- åŠ å¥½å‹ç•Œé¢ -->
<div id="add-modal" class="modal hidden">
    <div class="modal-content">
        <h2>æ·»åŠ å¥½å‹</h2>
        <div id="add-info" style="text-align:left; margin-bottom:1rem;"></div>
        <input id="add-msg" style="margin-bottom:1rem;">
        <button onclick="sendRequest()">å‘é€</button>
        <button class="danger" onclick="hideAdd()">å–æ¶ˆ</button>
    </div>
</div>

<!-- å¥½å‹ç”³è¯·æŸ¥çœ‹ -->
<div id="request-modal" class="modal hidden">
    <div class="modal-content">
        <h2>å¥½å‹ç”³è¯·</h2>
        <div id="request-info" style="text-align:left; margin:1rem 0;"></div>
        <button class="success" onclick="acceptRequest()">é€šè¿‡</button>
        <button class="danger" onclick="rejectRequest()">æ‹’ç»</button>
    </div>
</div>

<!-- å¥½å‹ç”³è¯·é€šçŸ¥ -->
<div id="request-notif" class="request-notif hidden" onclick="showPendingRequests()">æ–°å¥½å‹ç”³è¯·</div>

<script>
/* ==================== IndexedDB åˆå§‹åŒ– ==================== */
let db;
const request = indexedDB.open('ChatDB', 4);
request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains('users')) {
        const store = db.createObjectStore('users', { keyPath: 'id' });
        store.createIndex('user', 'user', { unique: true });
    }
    if (!db.objectStoreNames.contains('friends')) db.createObjectStore('friends', { keyPath: 'id', autoIncrement: true });
    if (!db.objectStoreNames.contains('messages')) db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
    if (!db.objectStoreNames.contains('requests')) db.createObjectStore('requests', { keyPath: 'id', autoIncrement: true });
};
request.onsuccess = e => { db = e.target.result; };
request.onerror = e => console.error(e);

/* ==================== å…¨å±€å˜é‡ ==================== */
let currentUser = null;
let currentChat = null;
let pendingRequest = null;

/* ==================== å·¥å…·å‡½æ•° ==================== */
function $(id) { return document.getElementById(id); }
function hide(id) { $(id).classList.add('hidden'); }
function show(id) { $(id).classList.remove('hidden'); }
function tx(store, mode, callback) {
    const txn = db.transaction(store, mode);
    const obj = txn.objectStore(store);
    callback(obj, txn);
}
function randomId(len) {
    let s = '';
    for (let i = 0; i < len; i++) s += Math.floor(Math.random() * 10);
    return s;
}
function copyMyId() {
    navigator.clipboard.writeText(currentUser.id);
    alert('ç¼–å·å·²å¤åˆ¶ï¼š' + currentUser.id);
}
function blobToUrl(blob) {
    return URL.createObjectURL(blob);
}

/* ==================== ç™»å½•æ³¨å†Œ ==================== */
function showLogin() { hide('register-modal'); show('login-modal'); }
function showRegister() { hide('login-modal'); show('register-modal'); }

function login() {
    const user = $('login-user').value.trim();
    const pass = $('login-pass').value;
    if (!/^[a-zA-Z0-9]{6,12}$/.test(user)) return alert('ç”¨æˆ·å 6-12 ä½å­—æ¯æ•°å­—');
    if (!/^[a-zA-Z0-9]{8,16}$/.test(pass)) return alert('å¯†ç  8-16 ä½å­—æ¯æ•°å­—');

    tx(['users'], 'readonly', (store, txn) => {
        const req = store.index('user').get(user);
        req.onsuccess = () => {
            const data = req.result;
            if (!data || data.pass !== pass) return alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            currentUser = data;
            initMain();
        };
    });
}

function register() {
    const user = $('reg-user').value.trim();
    const pass = $('reg-pass').value;
    const pass2 = $('reg-pass2').value;
    const file = $('reg-avatar').files[0];

    if (!/^[a-zA-Z0-9]{6,12}$/.test(user)) return alert('ç”¨æˆ·å 6-12 ä½å­—æ¯æ•°å­—');
    if (!/^[a-zA-Z0-9]{8,16}$/.test(pass)) return alert('å¯†ç  8-16 ä½å­—æ¯æ•°å­—');
    if (pass !== pass2) return alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');

    tx(['users'], 'readwrite', (store, txn) => {
        const check = store.index('user').get(user);
        check.onsuccess = () => {
            if (check.result) return alert('ç”¨æˆ·åå·²å­˜åœ¨');
            const id = randomId(Math.floor(Math.random() * 7) + 6); // 6-12ä½
            const reader = new FileReader();
            reader.onload = e => {
                const newUser = { user, pass, id, avatar: e.target.result };
                store.add(newUser).onsuccess = () => {
                    currentUser = newUser;
                    hide('register-modal');
                    show('name-modal');
                };
            };
            if (file) reader.readAsDataURL(file);
            else {
                // é»˜è®¤å¤´åƒ
                const canvas = document.createElement('canvas');
                canvas.width = 48; canvas.height = 48;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#555'; ctx.fillRect(0,0,48,48);
                ctx.fillStyle = '#fff'; ctx.font = '24px Arial'; ctx.textAlign = 'center';
                ctx.fillText(user[0].toUpperCase(), 24, 32);
                currentUser = { user, pass, id, avatar: canvas.toDataURL() };
                hide('register-modal');
                show('name-modal');
            }
        };
    });
}

function saveNickname() {
    const name = $('nickname').value.trim();
    if (name.length < 1 || name.length > 6) return alert('æ˜µç§° 1-6 ä½');
    currentUser.name = name;
    tx(['users'], 'readwrite', (store) => {
        store.put(currentUser).onsuccess = initMain;
    });
}

/* ==================== ä¸»ç•Œé¢ ==================== */
function initMain() {
    hide('login-modal'); hide('name-modal'); show('main');
    $('my-avatar').src = currentUser.avatar;
    $('my-name').textContent = currentUser.name;
    $('my-id').textContent = currentUser.id;
    loadFriends();
    loadRequests();
    setInterval(checkNewRequests, 2000);
}

function loadFriends() {
    const list = $('friend-list');
    list.innerHTML = '';
    tx(['friends'], 'readonly', (store) => {
        const req = store.index ? store.getAll() : store.openCursor();
        req.onsuccess = e => {
            const data = e.target.result || req.result;
            (Array.isArray(data) ? data : data ? [data] : []).forEach(f => {
                if (f.user1 === currentUser.id || f.user2 === currentUser.id) {
                    const other = f.user1 === currentUser.id ? f.user2 : f.user1;
                    getUserById(other, u => {
                        const div = document.createElement('div');
                        div.className = 'friend-item';
                        div.innerHTML = `<img class="avatar" src="${u.avatar}"><div><div>${u.name}</div><small style="color:#888;">${u.id}</small></div>`;
                        div.onclick = () => openChat(u);
                        list.appendChild(div);
                    });
                }
            });
        };
    });
}

function getUserById(id, cb) {
    tx(['users'], 'readonly', (store) => {
        const req = store.get(id);
        req.onsuccess = () => cb(req.result);
    });
}

/* ==================== æœç´¢ & åŠ å¥½å‹ ==================== */
function showSearch() { show('search-modal'); }
function hideSearch() { hide('search-modal'); $('search-id').value = ''; $('search-result').innerHTML = ''; }

function searchUser() {
    const id = $('search-id').value.trim();
    if (!/^\d{6,12}$/.test(id)) return alert('ç¼–å·ä¸º 6-12 ä½çº¯æ•°å­—');
    if (id === currentUser.id) return alert('ä¸èƒ½æ·»åŠ è‡ªå·±');

    tx(['friends'], 'readonly', (store) => {
        const req = store.getAll();
        req.onsuccess = () => {
            const exists = req.result.some(f => 
                (f.user1 === currentUser.id && f.user2 === id) ||
                (f.user2 === currentUser.id && f.user1 === id)
            );
            if (exists) return alert('ä½ ä»¬å·²æ˜¯å¥½å‹');

            getUserById(id, u => {
                if (!u) return alert('ç”¨æˆ·ä¸å­˜åœ¨');
                const res = $('search-result');
                res.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px; margin:1rem 0;">
                        <img class="avatar" src="${u.avatar}">
                        <div>
                            <div>${u.name}</div>
                            <small style="color:#888;">${u.id}</small>
                        </div>
                    </div>
                    <button onclick="prepareAdd('${u.id}', '${u.name}')">æ·»åŠ </button>
                `;
            });
        };
    });
}

let addTarget = null;
function prepareAdd(id, name) {
    addTarget = id;
    hide('search-modal');
    $('add-msg').value = `ä½ å¥½ï¼Œæˆ‘æ˜¯${currentUser.name}`;
    $('add-info').innerHTML = `å‘ <strong>${name}</strong> (<code>${id}</code>) å‘é€å¥½å‹ç”³è¯·`;
    show('add-modal');
}
function hideAdd() { hide('add-modal'); addTarget = null; }

function sendRequest() {
    if (!addTarget) return;
    const msg = $('add-msg').value;
    const req = {
        from: currentUser.id,
        to: addTarget,
        msg,
        time: Date.now(),
        status: 'pending'
    };
    tx(['requests'], 'readwrite', (store) => {
        store.add(req).onsuccess = () => {
            alert('ç”³è¯·å·²å‘é€');
            hideAdd();
        };
    });
}

/* ==================== å¥½å‹ç”³è¯· ==================== */
function checkNewRequests() {
    tx(['requests'], 'readonly', (store) => {
        const req = store.getAll();
        req.onsuccess = () => {
            const pending = req.result.filter(r => r.to === currentUser.id && r.status === 'pending');
            if (pending.length > 0) show('request-notif');
            else hide('request-notif');
        };
    });
}

function showPendingRequests() {
    tx(['requests'], 'readonly', (store) => {
        const req = store.getAll();
        req.onsuccess = () => {
            const pending = req.result.filter(r => r.to === currentUser.id && r.status === 'pending');
            if (pending.length === 0) return;
            const r = pending[0];
            pendingRequest = r;
            getUserById(r.from, u => {
                $('request-info').innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:1rem;">
                        <img class="avatar" src="${u.avatar}">
                        <div>
                            <div><strong>${u.name}</strong></div>
                            <small style="color:#888;">${u.id}</small>
                        </div>
                    </div>
                    <p style="background:#333; padding:0.8rem; border-radius:8px;">${r.msg}</p>
                `;
                show('request-modal');
            });
        };
    });
}

function acceptRequest() {
    if (!pendingRequest) return;
    pendingRequest.status = 'accepted';
    tx(['requests', 'friends'], 'readwrite', (reqStore, txn) => {
        reqStore.put(pendingRequest);
        const friend = {
            user1: currentUser.id,
            user2: pendingRequest.from,
            time: Date.now()
        };
        txn.objectStore('friends').add(friend);
    }).onsuccess = () => {
        hide('request-modal');
        loadFriends();
        alert('å·²é€šè¿‡å¥½å‹ç”³è¯·');
    };
}

function rejectRequest() {
    if (!pendingRequest) return;
    pendingRequest.status = 'rejected';
    tx(['requests'], 'readwrite', (store) => {
        store.put(pendingRequest).onsuccess = () => {
            hide('request-modal');
            alert('å·²æ‹’ç»');
        };
    });
}

/* ==================== èŠå¤© ==================== */
function openChat(user) {
    currentChat = user;
    $('chat-list').innerHTML = '';
    show('input-area');
    loadMessages();
    // åŠ è½½å†å²æ¶ˆæ¯
    tx(['messages'], 'readonly', (store) => {
        const req = store.getAll();
        req.onsuccess = () => {
            req.result
                .filter(m => 
                    (m.from === currentUser.id && m.to === user.id) ||
                    (m.from === user.id && m.to === currentUser.id)
                )
                .sort((a,b) => a.time - b.time)
                .forEach(m => appendMessage(m));
        };
    });
}

function appendMessage(m) {
    const div = document.createElement('div');
    div.className = 'msg ' + (m.from === currentUser.id ? 'me' : 'other');
    if (m.type === 'text') div.textContent = m.content;
    else if (m.type === 'image') {
        const img = document.createElement('img');
        img.src = m.content;
        img.style.maxWidth = '100%';
        img.onclick = () => window.open(m.content);
        div.appendChild(img);
    } else if (m.type === 'voice') {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = m.content;
        div.appendChild(audio);
    }
    $('chat-list').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
}

function loadMessages() {
    // å·²åœ¨ openChat ä¸­åŠ è½½
}

function sendMessage() {
    const input = $('msg-input');
    const text = input.value.trim();
    if (!text || !currentChat) return;
    const msg = {
        from: currentUser.id,
        to: currentChat.id,
        type: 'text',
        content: text,
        time: Date.now()
    };
    tx(['messages'], 'readwrite', (store) => {
        store.add(msg);
    });
    appendMessage(msg);
    input.value = '';
}

// å›¾ç‰‡
$('img-input').onchange = () => {
    const file = $('img-input').files[0];
    if (!file || !currentChat) return;
    const reader = new FileReader();
    reader.onload = e => {
        const msg = {
            from: currentUser.id,
            to: currentChat.id,
            type: 'image',
            content: e.target.result,
            time: Date.now()
        };
        tx(['messages'], 'readwrite', (store) => store.add(msg));
        appendMessage(msg);
    };
    reader.readAsDataURL(file);
    $('img-input').value = '';
};

// è¯­éŸ³
let recorder, audioBlob;
function startVoice() {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        recorder = new MediaRecorder(stream);
        recorder.start();
        recorder.ondataavailable = e => { audioBlob = e.data; };
        recorder.onstop = () => {
            const url = URL.createObjectURL(audioBlob);
            const msg = {
                from: currentUser.id,
                to: currentChat.id,
                type: 'voice',
                content: url,
                time: Date.now()
            };
            tx(['messages'], 'readwrite', (store) => store.add(msg));
            appendMessage(msg);
        };
        alert('å½•éŸ³ä¸­... ç‚¹å‡»å†æ¬¡åœæ­¢');
        document.querySelector('button[onclick="startVoice()"]').onclick = () => recorder.stop();
    });
}

// å¤´åƒé¢„è§ˆ
$('reg-avatar').onchange = () => {
    const file = $('reg-avatar').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            $('avatar-preview').src = e.target.result;
            show('avatar-preview');
        };
        reader.readAsDataURL(file);
    }
};
</script>
</body>
</html>
