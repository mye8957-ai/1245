<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简聊天</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#121212',
                        darker: '#0a0a0a',
                        primary: '#3b82f6',
                        secondary: '#1e293b',
                        accent: '#60a5fa',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-dark text-gray-200 min-h-screen flex flex-col overflow-hidden">
    <!-- 登录弹窗 -->
    <div id="loginModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-secondary rounded-lg w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-primary">登录</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-300 mb-2" for="loginUsername">用户名</label>
                    <input type="text" id="loginUsername" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="输入用户名">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2" for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="输入密码">
                </div>
                <button id="loginBtn" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-md transition-all-300">登录</button>
                <div class="text-center mt-4">
                    <span class="text-gray-400">没有账号？</span>
                    <button id="showRegisterBtn" class="text-primary hover:text-accent ml-1 transition-all-300">注册</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册弹窗 -->
    <div id="registerModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-secondary rounded-lg w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-primary">注册</h2>
            <div class="space-y-4">
                <div class="flex flex-col items-center">
                    <label for="avatarUpload" class="cursor-pointer">
                        <div id="avatarPreview" class="w-24 h-24 rounded-full bg-darker flex items-center justify-center border-2 border-dashed border-gray-600 overflow-hidden">
                            <<i class="fa fa-user text-4xl text-gray-500"></</i>
                        </div>
                        <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                    </label>
                    <p class="text-gray-400 text-sm mt-2">点击上传头像</p>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2" for="registerUsername">用户名</label>
                    <input type="text" id="registerUsername" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="6-12位数字和字母">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2" for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="8-16位数字和字母">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2" for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="再次输入密码">
                </div>
                <button id="registerBtn" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-md transition-all-300">注册</button>
                <div class="text-center mt-4">
                    <span class="text-gray-400">已有账号？</span>
                    <button id="showLoginBtn" class="text-primary hover:text-accent ml-1 transition-all-300">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 起名弹窗 -->
    <div id="nameModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-secondary rounded-lg w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-primary">设置昵称</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-300 mb-2" for="userNickname">昵称</label>
                    <input type="text" id="userNickname" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="1-6位，支持任意字符">
                </div>
                <button id="confirmNameBtn" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-md transition-all-300">确定</button>
            </div>
        </div>
    </div>

    <!-- 好友申请通知 -->
    <div id="requestNotification" class="fixed bottom-4 right-4 bg-secondary rounded-lg p-4 shadow-xl z-40 hidden flex items-center">
        <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mr-3">
            <<i class="fa fa-user-plus text-primary text-xl"></</i>
        </div>
        <div class="flex-1">
            <p class="text-gray-200 font-medium">新的好友申请</p>
            <p class="text-gray-400 text-sm">点击查看详情</p>
        </div>
        <button id="viewRequestBtn" class="ml-3 bg-primary hover:bg-accent text-white px-3 py-1 rounded-md text-sm transition-all-300">查看</button>
    </div>

    <!-- 好友申请处理界面 -->
    <div id="requestModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-secondary rounded-lg w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-primary">好友申请</h2>
            <div id="requestContent" class="space-y-4">
                <!-- 申请内容将动态生成 -->
            </div>
            <button id="closeRequestBtn" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-all-300">关闭</button>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainContainer" class="flex flex-1 overflow-hidden hidden">
        <!-- 侧边栏 -->
        <div class="w-64 bg-secondary border-r border-gray-800 flex flex-col">
            <!-- 用户信息 -->
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center">
                    <div id="mainAvatar" class="w-12 h-12 rounded-full overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary transition-all-300">
                        <img src="https://via.placeholder.com/100" alt="头像" class="w-full h-full object-cover">
                    </div>
                    <div class="ml-3">
                        <h3 id="mainNickname" class="font-medium text-white">昵称</h3>
                        <p id="userIdDisplay" class="text-gray-400 text-sm">ID: 123456</p>
                    </div>
                </div>
            </div>

            <!-- 搜索栏 -->
            <div class="p-4 border-b border-gray-800">
                <div class="relative">
                    <input type="text" id="searchInput" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 pl-10 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="输入对方编号搜索">
                    <<i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></</i>
                </div>
                <button id="searchBtn" class="w-full mt-2 bg-primary hover:bg-accent text-white font-medium py-1.5 px-4 rounded-md transition-all-300 text-sm">搜索</button>
            </div>

            <!-- 好友列表 -->
            <div class="flex-1 overflow-y-auto scrollbar-hide">
                <h4 class="text-gray-400 text-sm px-4 py-2 border-b border-gray-800">好友列表</h4>
                <div id="friendsList" class="p-2">
                    <!-- 好友列表将动态生成 -->
                    <div class="text-gray-500 text-center py-8">
                        <<i class="fa fa-users text-4xl mb-2"></</i>
                        <p>暂无好友，快去添加吧</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="flex-1 flex flex-col bg-darker">
            <!-- 聊天头部 -->
            <div id="chatHeader" class="p-4 border-b border-gray-800 flex items-center hidden">
                <div id="chatFriendAvatar" class="w-10 h-10 rounded-full overflow-hidden">
                    <img src="https://via.placeholder.com/100" alt="好友头像" class="w-full h-full object-cover">
                </div>
                <h3 id="chatFriendName" class="ml-3 font-medium text-white">好友名称</h3>
                <div class="flex-1"></div>
                <button id="backToFriendsBtn" class="text-gray-400 hover:text-white transition-all-300">
                    <<i class="fa fa-arrow-left text-xl"></</i>
                </button>
            </div>

            <!-- 空聊天界面 -->
            <div id="emptyChat" class="flex-1 flex flex-col items-center justify-center">
                <div class="w-24 h-24 rounded-full bg-secondary flex items-center justify-center mb-4">
                    <<i class="fa fa-comments text-4xl text-gray-500"></</i>
                </div>
                <h3 class="text-xl font-medium text-white mb-2">选择一个好友开始聊天</h3>
                <p class="text-gray-400">点击好友列表中的好友，即可开始对话</p>
            </div>

            <!-- 聊天内容 -->
            <div id="chatContent" class="flex-1 p-4 overflow-y-auto scrollbar-hide hidden">
                <div id="messagesContainer" class="space-y-4">
                    <!-- 消息将动态生成 -->
                </div>
            </div>

            <!-- 聊天输入框 -->
            <div id="chatInputArea" class="p-4 border-t border-gray-800 hidden">
                <div class="flex items-center space-x-2">
                    <button id="sendImageBtn" class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-gray-300 hover:bg-gray-700 transition-all-300">
                        <<i class="fa fa-image"></</i>
                    </button>
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    <button id="sendVoiceBtn" class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-gray-300 hover:bg-gray-700 transition-all-300">
                        <<i class="fa fa-microphone"></</i>
                    </button>
                    <input type="text" id="messageInput" class="flex-1 bg-secondary border border-gray-700 rounded-full px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="输入消息...">
                    <button id="sendMessageBtn" class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white hover:bg-accent transition-all-300">
                        <<i class="fa fa-paper-plane"></</i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加好友界面 -->
    <div id="addFriendModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-secondary rounded-lg w-full max-w-md p-6 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-primary">添加好友</h2>
            <div id="foundUserInfo" class="flex items-center mb-4 hidden">
                <div id="foundUserAvatar" class="w-12 h-12 rounded-full overflow-hidden">
                    <img src="https://via.placeholder.com/100" alt="用户头像" class="w-full h-full object-cover">
                </div>
                <div class="ml-3">
                    <h3 id="foundUserName" class="font-medium text-white">用户名</h3>
                    <p id="foundUserId" class="text-gray-400 text-sm">ID: 123456</p>
                </div>
            </div>
            <div id="userNotFound" class="text-center py-4 text-gray-400 hidden">
                <<i class="fa fa-search text-4xl mb-2"></</i>
                <p>未找到该用户</p>
            </div>
            <div>
                <label class="block text-gray-300 mb-2" for="friendRequestMsg">申请消息</label>
                <input type="text" id="friendRequestMsg" class="w-full bg-darker border border-gray-700 rounded-md px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="你好，我是xxx">
            </div>
            <div class="flex space-x-2 mt-4">
                <button id="sendRequestBtn" class="flex-1 bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-md transition-all-300">发送申请</button>
                <button id="closeAddFriendBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-all-300">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 数据存储模块
        const DataStore = {
            // 获取用户数据
            getUserData() {
                const data = localStorage.getItem('chatUserData');
                return data ? JSON.parse(data) : null;
            },

            // 保存用户数据
            saveUserData(userData) {
                localStorage.setItem('chatUserData', JSON.stringify(userData));
            },

            // 获取所有用户（用于搜索）
            getAllUsers() {
                const users = localStorage.getItem('chatAllUsers');
                return users ? JSON.parse(users) : [];
            },

            // 添加新用户
            addUser(userData) {
                const users = this.getAllUsers();
                users.push(userData);
                localStorage.setItem('chatAllUsers', JSON.stringify(users));
            },

            // 根据编号查找用户
            findUserById(userId) {
                const users = this.getAllUsers();
                return users.find(user => user.id === userId);
            },

            // 根据用户名查找用户
            findUserByUsername(username) {
                const users = this.getAllUsers();
                return users.find(user => user.username === username);
            },

            // 保存好友申请
            saveFriendRequest(request) {
                const requests = this.getFriendRequests();
                requests.push(request);
                localStorage.setItem('chatFriendRequests', JSON.stringify(requests));
            },

            // 获取好友申请
            getFriendRequests() {
                const requests = localStorage.getItem('chatFriendRequests');
                return requests ? JSON.parse(requests) : [];
            },

            // 删除好友申请
            removeFriendRequest(index) {
                const requests = this.getFriendRequests();
                requests.splice(index, 1);
                localStorage.setItem('chatFriendRequests', JSON.stringify(requests));
            },

            // 添加好友
            addFriend(currentUserId, friendId) {
                const currentUser = this.findUserById(currentUserId);
                const friend = this.findUserById(friendId);
                
                if (currentUser && friend) {
                    // 给当前用户添加好友
                    if (!currentUser.friends) currentUser.friends = [];
                    if (!currentUser.friends.includes(friendId)) {
                        currentUser.friends.push(friendId);
                    }

                    // 给对方添加好友
                    if (!friend.friends) friend.friends = [];
                    if (!friend.friends.includes(currentUserId)) {
                        friend.friends.push(currentUserId);
                    }

                    // 更新用户数据
                    const users = this.getAllUsers();
                    const currentUserIndex = users.findIndex(u => u.id === currentUserId);
                    const friendIndex = users.findIndex(u => u.id === friendId);
                    
                    if (currentUserIndex !== -1) users[currentUserIndex] = currentUser;
                    if (friendIndex !== -1) users[friendIndex] = friend;
                    
                    localStorage.setItem('chatAllUsers', JSON.stringify(users));
                    
                    // 更新当前用户数据
                    if (this.getUserData()?.id === currentUserId) {
                        this.saveUserData(currentUser);
                    }
                }
            },

            // 获取好友列表
            getFriends(userId) {
                const user = this.findUserById(userId);
                if (!user || !user.friends) return [];
                
                return user.friends.map(friendId => this.findUserById(friendId)).filter(friend => friend);
            },

            // 保存聊天记录
            saveMessage(senderId, receiverId, message) {
                const key = `chatMessages_${Math.min(senderId, receiverId)}_${Math.max(senderId, receiverId)}`;
                const messages = this.getMessages(senderId, receiverId);
                
                messages.push({
                    id: Date.now().toString(),
                    senderId,
                    receiverId,
                    content: message.content,
                    type: message.type, // text, image, voice
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem(key, JSON.stringify(messages));
            },

            // 获取聊天记录
            getMessages(userId1, userId2) {
                const key = `chatMessages_${Math.min(userId1, userId2)}_${Math.max(userId1, userId2)}`;
                const messages = localStorage.getItem(key);
                return messages ? JSON.parse(messages) : [];
            }
        };

        // 工具函数
        const Utils = {
            // 生成6-12位随机数字编号
            generateRandomId() {
                const length = Math.floor(Math.random() * 7) + 6; // 6-12位
                let id = '';
                for (let i = 0; i < length; i++) {
                    id += Math.floor(Math.random() * 10).toString();
                }
                return id;
            },

            // 验证用户名格式（6-12位数字和字母）
            validateUsername(username) {
                const regex = /^[a-zA-Z0-9]{6,12}$/;
                return regex.test(username);
            },

            // 验证密码格式（8-16位数字和字母）
            validatePassword(password) {
                const regex = /^[a-zA-Z0-9]{8,16}$/;
                return regex.test(password);
            },

            // 验证昵称格式（1-6位任意字符）
            validateNickname(nickname) {
                return nickname.length >= 1 && nickname.length <= 6;
            },

            // 复制到剪贴板
            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('编号已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                });
            },

            // 格式化时间
            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },

            // 图片转base64
            async imageToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (err) => reject(err);
                    reader.readAsDataURL(file);
                });
            }
        };

        // 主应用逻辑
        const ChatApp = {
            currentUser: null,
            currentChatFriend: null,

            init() {
                this.bindEvents();
                this.checkLoginStatus();
                this.checkFriendRequests();
            },

            // 绑定所有事件
            bindEvents() {
                // 登录注册相关
                document.getElementById('showRegisterBtn').addEventListener('click', () => this.showRegisterModal());
                document.getElementById('showLoginBtn').addEventListener('click', () => this.showLoginModal());
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('registerBtn').addEventListener('click', () => this.register());
                document.getElementById('confirmNameBtn').addEventListener('click', () => this.confirmName());
                
                // 头像上传预览
                document.getElementById('avatarUpload').addEventListener('change', (e) => this.previewAvatar(e));
                
                // 主界面相关
                document.getElementById('mainAvatar').addEventListener('click', () => this.copyUserId());
                document.getElementById('searchBtn').addEventListener('click', () => this.searchUser());
                
                // 好友申请相关
                document.getElementById('viewRequestBtn').addEventListener('click', () => this.showFriendRequests());
                document.getElementById('closeRequestBtn').addEventListener('click', () => this.hideRequestModal());
                
                // 添加好友相关
                document.getElementById('sendRequestBtn').addEventListener('click', () => this.sendFriendRequest());
                document.getElementById('closeAddFriendBtn').addEventListener('click', () => this.hideAddFriendModal());
                
                // 聊天相关
                document.getElementById('backToFriendsBtn').addEventListener('click', () => this.backToFriends());
                document.getElementById('sendMessageBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                document.getElementById('sendImageBtn').addEventListener('click', () => document.getElementById('imageUpload').click());
                document.getElementById('imageUpload').addEventListener('change', (e) => this.sendImage(e));
                document.getElementById('sendVoiceBtn').addEventListener('click', () => this.startRecording());
            },

            // 检查登录状态
            checkLoginStatus() {
                const userData = DataStore.getUserData();
                if (userData) {
                    this.currentUser = userData;
                    this.showMainInterface();
                    this.renderUserInfo();
                    this.renderFriendsList();
                } else {
                    this.showLoginModal();
                }
            },

            // 检查好友申请
            checkFriendRequests() {
                const userData = DataStore.getUserData();
                if (userData) {
                    const requests = DataStore.getFriendRequests().filter(req => req.receiverId === userData.id);
                    if (requests.length > 0) {
                        document.getElementById('requestNotification').classList.remove('hidden');
                    }
                }
            },

            // 显示登录弹窗
            showLoginModal() {
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('registerModal').classList.add('hidden');
                document.getElementById('nameModal').classList.add('hidden');
            },

            // 显示注册弹窗
            showRegisterModal() {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('registerModal').classList.remove('hidden');
                document.getElementById('nameModal').classList.add('hidden');
            },

            // 显示起名弹窗
            showNameModal() {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('registerModal').classList.add('hidden');
                document.getElementById('nameModal').classList.remove('hidden');
            },

            // 显示主界面
            showMainInterface() {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('registerModal').classList.add('hidden');
                document.getElementById('nameModal').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
            },

            // 预览头像
            previewAvatar(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('avatarPreview').innerHTML = `<img src="${event.target.result}" alt="预览" class="w-full h-full object-cover">`;
                    };
                    reader.readAsDataURL(file);
                }
            },

            // 登录
            login() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();

                if (!username || !password) {
                    alert('请填写用户名和密码');
                    return;
                }

                const user = DataStore.findUserByUsername(username);
                if (!user || user.password !== password) {
                    alert('用户名或密码错误');
                    return;
                }

                // 保存当前用户数据
                DataStore.saveUserData(user);
                this.currentUser = user;
                
                this.showMainInterface();
                this.renderUserInfo();
                this.renderFriendsList();
                this.checkFriendRequests();
            },

            // 注册
            register() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('confirmPassword').value.trim();
                const avatarPreview = document.getElementById('avatarPreview').innerHTML;

                // 验证用户名
                if (!Utils.validateUsername(username)) {
                    alert('用户名必须是6-12位数字和字母');
                    return;
                }

                // 验证密码
                if (!Utils.validatePassword(password)) {
                    alert('密码必须是8-16位数字和字母');
                    return;
                }

                // 验证密码一致性
                if (password !== confirmPassword) {
                    alert('两次输入的密码不一致');
                    return;
                }

                // 检查用户名是否已存在
                if (DataStore.findUserByUsername(username)) {
                    alert('用户名已存在');
                    return;
                }

                // 生成用户ID
                const userId = Utils.generateRandomId();

                // 处理头像
                let avatar = 'https://via.placeholder.com/100';
                if (avatarPreview.includes('img src')) {
                    const imgSrc = avatarPreview.match(/src="([^"]+)"/)[1];
                    avatar = imgSrc;
                }

                // 创建用户数据
                this.currentUser = {
                    id: userId,
                    username,
                    password,
                    avatar,
                    nickname: '',
                    friends: []
                };

                // 保存用户
                DataStore.addUser(this.currentUser);
                DataStore.saveUserData(this.currentUser);

                // 显示起名弹窗
                this.showNameModal();
            },

            // 确认昵称
            confirmName() {
                const nickname = document.getElementById('userNickname').value.trim();

                if (!Utils.validateNickname(nickname)) {
                    alert('昵称必须是1-6位字符');
                    return;
                }

                // 更新用户昵称
                this.currentUser.nickname = nickname;
                DataStore.saveUserData(this.currentUser);
                
                // 更新所有用户列表中的数据
                const users = DataStore.getAllUsers();
                const userIndex = users.findIndex(u => u.id === this.currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = this.currentUser;
                    localStorage.setItem('chatAllUsers', JSON.stringify(users));
                }

                // 显示主界面
                this.showMainInterface();
                this.renderUserInfo();
                this.renderFriendsList();
            },

            // 渲染用户信息
            renderUserInfo() {
                if (!this.currentUser) return;

                // 更新头像
                document.getElementById('mainAvatar').innerHTML = `<img src="${this.currentUser.avatar}" alt="头像" class="w-full h-full object-cover">`;
                
                // 更新昵称
                document.getElementById('mainNickname').textContent = this.currentUser.nickname;
                
                // 更新用户ID
                document.getElementById('userIdDisplay').textContent = `ID: ${this.currentUser.id}`;
            },

            // 复制用户ID
            copyUserId() {
                if (this.currentUser) {
                    Utils.copyToClipboard(this.currentUser.id);
                }
            },

            // 搜索用户
            searchUser() {
                const userId = document.getElementById('searchInput').value.trim();

                if (!userId) {
                    alert('请输入对方编号');
                    return;
                }

                const user = DataStore.findUserById(userId);

                if (!user) {
                    // 显示未找到
                    document.getElementById('foundUserInfo').classList.add('hidden');
                    document.getElementById('userNotFound').classList.remove('hidden');
                    document.getElementById('sendRequestBtn').disabled = true;
                    document.getElementById('sendRequestBtn').classList.add('opacity-50', 'cursor-not-allowed');
                } else if (user.id === this.currentUser.id) {
                    alert('不能添加自己为好友');
                } else {
                    // 检查是否已是好友
                    const isFriend = this.currentUser.friends && this.currentUser.friends.includes(user.id);
                    if (isFriend) {
                        alert('该用户已是你的好友');
                        return;
                    }

                    // 显示找到的用户信息
                    document.getElementById('foundUserAvatar').innerHTML = `<img src="${user.avatar}" alt="头像" class="w-full h-full object-cover">`;
                    document.getElementById('foundUserName').textContent = user.nickname;
                    document.getElementById('foundUserId').textContent = `ID: ${user.id}`;
                    
                    document.getElementById('foundUserInfo').classList.remove('hidden');
                    document.getElementById('userNotFound').classList.add('hidden');
                    document.getElementById('sendRequestBtn').disabled = false;
                    document.getElementById('sendRequestBtn').classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    // 设置默认申请消息
                    document.getElementById('friendRequestMsg').value = `你好，我是${this.currentUser.nickname}`;
                    
                    // 保存当前搜索到的用户
                    this.currentChatFriend = user;
                }

                // 显示添加好友界面
                document.getElementById('addFriendModal').classList.remove('hidden');
            },

            // 发送好友申请
            sendFriendRequest() {
                if (!this.currentChatFriend) return;

                const message = document.getElementById('friendRequestMsg').value.trim() || `你好，我是${this.currentUser.nickname}`;

                // 创建申请
                const request = {
                    id: Date.now().toString(),
                    senderId: this.currentUser.id,
                    senderName: this.currentUser.nickname,
                    senderAvatar: this.currentUser.avatar,
                    receiverId: this.currentChatFriend.id,
                    message,
                    timestamp: new Date().toISOString()
                };

                // 保存申请
                DataStore.saveFriendRequest(request);

                alert('好友申请已发送');
                this.hideAddFriendModal();
            },

            // 隐藏添加好友界面
            hideAddFriendModal() {
                document.getElementById('addFriendModal').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            },

            // 显示好友申请
            showFriendRequests() {
                const requests = DataStore.getFriendRequests().filter(req => req.receiverId === this.currentUser.id);
                const requestContent = document.getElementById('requestContent');

                if (requests.length === 0) {
                    requestContent.innerHTML = '<div class="text-center py-4 text-gray-400">暂无好友申请</div>';
                } else {
                    requestContent.innerHTML = '';
                    requests.forEach((request, index) => {
                        const requestElement = document.createElement('div');
                        requestElement.className = 'p-4 bg-darker rounded-lg border border-gray-700';
                        requestElement.innerHTML = `
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full overflow-hidden">
                                    <img src="${request.senderAvatar}" alt="头像" class="w-full h-full object-cover">
                                </div>
                                <div class="ml-2">
                                    <h4 class="font-medium text-white">${request.senderName}</h4>
                                    <p class="text-gray-400 text-sm">ID: ${request.senderId}</p>
                                </div>
                            </div>
                            <p class="text-gray-300 mb-3">${request.message}</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 bg-primary hover:bg-accent text-white py-1.5 px-3 rounded-md transition-all-300" onclick="ChatApp.acceptFriendRequest(${index})">通过</button>
                                <button class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-1.5 px-3 rounded-md transition-all-300" onclick="ChatApp.rejectFriendRequest(${index})">拒绝</button>
                            </div>
                        `;
                        requestContent.appendChild(requestElement);
                    });
                }

                document.getElementById('requestModal').classList.remove('hidden');
                document.getElementById('requestNotification').classList.add('hidden');
            },

            // 隐藏好友申请界面
            hideRequestModal() {
                document.getElementById('requestModal').classList.add('hidden');
            },

            // 接受好友申请
            acceptFriendRequest(index) {
                const requests = DataStore.getFriendRequests();
                const request = requests[index];

                // 添加好友
                DataStore.addFriend(this.currentUser.id, request.senderId);

                // 删除申请
                DataStore.removeFriendRequest(index);

                // 更新界面
                this.renderFriendsList();
                this.showFriendRequests();
            },

            // 拒绝好友申请
            rejectFriendRequest(index) {
                // 删除申请
                DataStore.removeFriendRequest(index);

                // 更新界面
                this.showFriendRequests();
            },

            // 渲染好友列表
            renderFriendsList() {
                const friends = DataStore.getFriends(this.currentUser.id);
                const friendsList = document.getElementById('friendsList');

                if (friends.length === 0) {
                    friendsList.innerHTML = `
                        <div class="text-gray-500 text-center py-8">
                            <<i class="fa fa-users text-4xl mb-2"></</i>
                            <p>暂无好友，快去添加吧</p>
                        </div>
                    `;
                } else {
                    friendsList.innerHTML = '';
                    friends.forEach(friend => {
                        const friendElement = document.createElement('div');
                        friendElement.className = 'flex items-center p-2 rounded-md hover:bg-darker cursor-pointer transition-all-300';
                        friendElement.innerHTML = `
                            <div class="w-10 h-10 rounded-full overflow-hidden">
                                <img src="${friend.avatar}" alt="头像" class="w-full h-full object-cover">
                            </div>
                            <div class="ml-3">
                                <h4 class="font-medium text-white">${friend.nickname}</h4>
                                <p class="text-gray-400 text-sm">ID: ${friend.id}</p>
                            </div>
                        `;
                        friendElement.addEventListener('click', () => this.openChat(friend));
                        friendsList.appendChild(friendElement);
                    });
                }
            },

            // 打开聊天界面
            openChat(friend) {
                this.currentChatFriend = friend;

                // 更新聊天头部
                document.getElementById('chatFriendAvatar').innerHTML = `<img src="${friend.avatar}" alt="头像" class="w-full h-full object-cover">`;
                document.getElementById('chatFriendName').textContent = friend.nickname;

                // 显示聊天界面，隐藏空界面
                document.getElementById('emptyChat').classList.add('hidden');
                document.getElementById('chatHeader').classList.remove('hidden');
                document.getElementById('chatContent').classList.remove('hidden');
                document.getElementById('chatInputArea').classList.remove('hidden');

                // 加载聊天记录
                this.loadMessages();
            },

            // 返回好友列表
            backToFriends() {
                this.currentChatFriend = null;

                // 显示空界面，隐藏聊天界面
                document.getElementById('emptyChat').classList.remove('hidden');
                document.getElementById('chatHeader').classList.add('hidden');
                document.getElementById('chatContent').classList.add('hidden');
                document.getElementById('chatInputArea').classList.add('hidden');
            },

            // 加载聊天记录
            loadMessages() {
                if (!this.currentChatFriend) return;

                const messages = DataStore.getMessages(this.currentUser.id, this.currentChatFriend.id);
                const messagesContainer = document.getElementById('messagesContainer');

                messagesContainer.innerHTML = '';

                messages.forEach(message => {
                    const isSelf = message.senderId === this.currentUser.id;
                    const messageElement = document.createElement('div');
                    messageElement.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

                    let messageContent = '';
                    switch (message.type) {
                        case 'text':
                            messageContent = `<div class="max-w-[70%] p-3 rounded-lg ${isSelf ? 'bg-primary text-white' : 'bg-secondary text-gray-200'}">${message.content}</div>`;
                            break;
                        case 'image':
                            messageContent = `<div class="max-w-[50%] rounded-lg overflow-hidden ${isSelf ? 'bg-primary/10' : 'bg-secondary/50'}">
                                                <img src="${message.content}" alt="图片" class="w-full h-auto">
                                            </div>`;
                            break;
                        case 'voice':
                            messageContent = `<div class="w-[60%] p-3 rounded-lg ${isSelf ? 'bg-primary text-white' : 'bg-secondary text-gray-200'} flex items-center">
                                                <<i class="fa fa-volume-up mr-2"></</i>
                                                <audio controls class="w-full">
                                                    <source src="${message.content}" type="audio/mpeg">
                                                    您的浏览器不支持音频播放
                                                </audio>
                                            </div>`;
                            break;
                    }

                    messageElement.innerHTML = `
                        ${!isSelf ? `<div class="w-8 h-8 rounded-full overflow-hidden mr-2">
                                        <img src="${this.currentChatFriend.avatar}" alt="头像" class="w-full h-full object-cover">
                                    </div>` : ''}
                        <div class="flex flex-col ${isSelf ? 'items-end' : 'items-start'}">
                            ${messageContent}
                            <span class="text-xs text-gray-400 mt-1">${Utils.formatTime(message.timestamp)}</span>
                        </div>
                        ${isSelf ? `<div class="w-8 h-8 rounded-full overflow-hidden ml-2">
                                        <img src="${this.currentUser.avatar}" alt="头像" class="w-full h-full object-cover">
                                    </div>` : ''}
                    `;

                    messagesContainer.appendChild(messageElement);
                });

                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            },

            // 发送消息
            sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();

                if (!content || !this.currentChatFriend) return;

                // 保存消息
                DataStore.saveMessage(this.currentUser.id, this.currentChatFriend.id, {
                    content,
                    type: 'text'
                });

                // 清空输入框
                messageInput.value = '';

                // 重新加载消息
                this.loadMessages();
            },

            // 发送图片
            async sendImage(e) {
                const file = e.target.files[0];
                if (!file || !this.currentChatFriend) return;

                try {
                    const base64 = await Utils.imageToBase64(file);

                    // 保存消息
                    DataStore.saveMessage(this.currentUser.id, this.currentChatFriend.id, {
                        content: base64,
                        type: 'image'
                    });

                    // 重新加载消息
                    this.loadMessages();

                    // 重置文件输入
                    document.getElementById('imageUpload').value = '';
                } catch (err) {
                    console.error('发送图片失败:', err);
                    alert('发送图片失败');
                }
            },

            // 开始录音
            startRecording() {
                if (!this.currentChatFriend) return;

                alert('语音功能已触发，实际项目中可集成WebRTC或录音API实现');
                // 实际实现需要使用MediaRecorder API
            }
        };

        // 初始化应用
        window.ChatApp = ChatApp;
        document.addEventListener('DOMContentLoaded', () => ChatApp.init());
    </script>
</body>
</html>
